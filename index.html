<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS IAM 账号管理系统 (GitHub)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-card-hover: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --sold-overlay: rgba(248, 250, 252, 0.7);
        }

        [data-theme="dark"] {
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-card-hover: #27272a;
            --border-color: #27272a;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --sold-overlay: rgba(9, 9, 11, 0.7);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            padding: 2rem;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-size: 0.875rem;
            gap: 0.5rem;
        }

        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-outline { background-color: transparent; border-color: var(--border-color); color: var(--text-secondary); }
        .btn-outline:hover { border-color: var(--text-primary); color: var(--text-primary); background-color: var(--bg-card-hover); }
        .btn-outline.active { background-color: var(--text-primary); color: var(--bg-body); border-color: var(--text-primary); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #dc2626; }

        .icon { width: 1.25rem; height: 1.25rem; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        header { margin-bottom: 3rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        h1 { font-size: 2rem; font-weight: 700; letter-spacing: -0.025em; color: var(--text-primary); }
        [data-theme="dark"] h1 { background: linear-gradient(to right, #fff, #a1a1aa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .theme-toggle { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .theme-toggle:hover { color: var(--text-primary); border-color: var(--text-muted); }

        .stats-bar { display: flex; gap: 1rem; flex-wrap: wrap; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); padding: 1rem 1.5rem; border-radius: 0.75rem; min-width: 140px; }
        .stat-card.clickable { cursor: pointer; transition: all 0.2s ease; }
        .stat-card.clickable:hover { border-color: var(--text-muted); transform: translateY(-2px); }
        .stat-card.clickable.active { border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-primary); }
        .stat-label { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.5rem; font-weight: 600; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem; }

        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1rem; overflow: hidden; transition: all 0.3s ease; position: relative; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-2px); border-color: var(--text-muted); box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5); }
        .card.sold { border-color: var(--border-color); opacity: 0.85; }
        .card.sold::after { content: "已售"; position: absolute; top: 1rem; right: 1rem; font-size: 3rem; font-weight: 800; color: rgba(255, 255, 255, 0.05); pointer-events: none; transform: rotate(-15deg); z-index: 0; }

        .card-header { padding: 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.02); position: relative; z-index: 1; }
        .account-info { display: flex; align-items: center; gap: 0.5rem; overflow: hidden; }
        .account-index { font-weight: 700; color: var(--accent-primary); font-size: 0.9rem; flex-shrink: 0; }
        .account-email { font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; font-size: 0.95rem; }

        .status-badge { font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 99px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-available { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-sold { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .status-personal { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.2); }

        .kiro-badge { font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 600; margin-left: 0.5rem; }
        .kiro-badge.pro-plus { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .kiro-badge.pro { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .kiro-badge.power { background: rgba(249, 115, 22, 0.15); color: #f97316; border: 1px solid rgba(249, 115, 22, 0.3); }
        .kiro-badge.disabled { background: rgba(113, 113, 122, 0.1); color: var(--text-muted); border: 1px solid rgba(113, 113, 122, 0.2); }

        .created-date { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 200; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        #confirmModal { z-index: 300; }

        .modal { background: var(--bg-card); border-radius: 1rem; padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; line-height: 1; }
        .modal-close:hover { color: var(--text-primary); }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background: var(--bg-body); color: var(--text-primary); font-size: 0.9rem; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }

        .card-body { padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; flex: 1; position: relative; z-index: 1; }
        .field-group { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .field-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; width: 40px; }
        .field-value { font-size: 0.9rem; color: var(--text-secondary); background: rgba(0, 0, 0, 0.2); padding: 0.4rem 0.6rem; border-radius: 0.375rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; border: 1px solid transparent; }
        .field-value:hover { border-color: var(--border-color); color: var(--text-primary); }

        .copy-btn-icon { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; transition: color 0.2s; }
        .copy-btn-icon:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.05); }

        .card-footer { padding: 1.25rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.1); position: relative; z-index: 1; }
        .toggle-container { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .toggle-label { font-size: 0.875rem; color: var(--text-secondary); }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-card-hover); transition: .4s; border-radius: 24px; border: 1px solid var(--border-color); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: var(--text-muted); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--danger); border-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(20px); background-color: white; }
        .switch.personal input:checked + .slider { background-color: #8b5cf6; border-color: #8b5cf6; }
        .sold-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; display: block; }

        #toast { visibility: hidden; min-width: 250px; background-color: var(--text-primary); color: var(--bg-body); text-align: center; border-radius: 0.5rem; padding: 1rem; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: 500; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        .message-container { text-align: center; padding: 4rem; color: var(--text-muted); background: var(--bg-card); border-radius: 1rem; border: 1px dashed var(--border-color); }
        .error-text { color: var(--danger); margin-bottom: 1rem; }

        .github-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; background: rgba(36, 41, 47, 0.1); border-radius: 1rem; font-size: 0.75rem; color: var(--text-secondary); }
        [data-theme="dark"] .github-badge { background: rgba(255, 255, 255, 0.1); }

        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 50%; border-top-color: var(--accent-primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            h1 { font-size: 1.25rem; }
            .grid { grid-template-columns: 1fr; }
            .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
            .stat-card { padding: 0.75rem; min-width: auto; text-align: center; }
            .stat-label { font-size: 0.75rem; }
            .stat-value { font-size: 1.25rem; }
            header { margin-bottom: 1.5rem; gap: 1rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="top-bar">
            <div style="display:flex;align-items:center;gap:1rem;">
                <h1>AWS IAM 账号管理系统</h1>
                <span class="github-badge">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                    GitHub Storage
                </span>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="manualBackup()" title="备份数据">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    备份
                </button>
                <button class="btn btn-outline" onclick="showImportModal()" title="导入账号">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    导入
                </button>
                <button class="btn btn-outline" onclick="showConfigModal()" title="配置 GitHub">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    配置
                </button>
                <button class="theme-toggle" id="themeToggle" title="切换主题">
                    <svg class="icon" id="themeIcon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card clickable active" data-filter="all" id="filter-all">
                <div class="stat-label">账号总数</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card clickable" data-filter="available" id="filter-available">
                <div class="stat-label">可用</div>
                <div class="stat-value" id="stat-available" style="color: var(--success)">0</div>
            </div>
            <div class="stat-card clickable" data-filter="personal" id="filter-personal">
                <div class="stat-label">自用</div>
                <div class="stat-value" id="stat-personal" style="color: #8b5cf6">0</div>
            </div>
            <div class="stat-card clickable" data-filter="sold" id="filter-sold">
                <div class="stat-label">已售</div>
                <div class="stat-value" id="stat-sold" style="color: var(--danger)">0</div>
            </div>
        </div>
    </header>

    <div id="account-grid" class="grid"></div>
</div>

<div id="toast">已复制到剪贴板!</div>

<!-- Password Modal -->
<div class="modal-overlay" id="passwordModal">
    <div class="modal" style="max-width:360px">
        <div class="modal-header">
            <h3 class="modal-title">访问验证</h3>
        </div>
        <div class="form-group">
            <label class="form-label">请输入访问密码</label>
            <input type="password" class="form-input mono" id="accessPassword" placeholder="密码" onkeydown="if(event.key==='Enter')verifyPassword()">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="verifyPassword()" style="width:100%">确认</button>
        </div>
    </div>
</div>

<!-- GitHub Config Modal -->
<div class="modal-overlay" id="configModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">GitHub 配置</h3>
            <button class="modal-close" onclick="closeConfigModal()">&times;</button>
        </div>
        <div class="form-group">
            <label class="form-label">GitHub Personal Access Token</label>
            <input type="password" class="form-input mono" id="githubToken" placeholder="github_pat_xxxxx 或 ghp_xxxxx">
            <small style="color:var(--text-muted);font-size:0.75rem;margin-top:0.25rem;display:block;">
                需要 repo 权限。<a href="https://github.com/settings/tokens/new?scopes=repo&description=AWS-IAM-Manager" target="_blank" style="color:var(--accent-primary)">创建 Token</a>
            </small>
        </div>
        <div class="form-group">
            <label class="form-label">仓库名称</label>
            <input type="text" class="form-input" id="githubRepo" placeholder="owner/repo (例: username/aws-accounts-data)">
        </div>
        <div class="form-group">
            <label class="form-label">分支</label>
            <input type="text" class="form-input" id="githubBranch" placeholder="main" value="main">
        </div>
        <div class="form-actions">
            <button class="btn btn-outline" onclick="closeConfigModal()">取消</button>
            <button class="btn btn-primary" onclick="saveGitHubConfig()">保存并连接</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:400px">
        <div class="modal-header">
            <h3 class="modal-title" id="confirmTitle">确认操作</h3>
        </div>
        <p id="confirmMessage" style="color:var(--text-secondary);margin-bottom:1.5rem"></p>
        <div class="form-actions">
            <button class="btn btn-outline" onclick="closeConfirmModal(false)">取消</button>
            <button class="btn btn-primary" id="confirmBtn" onclick="closeConfirmModal(true)">确认</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="importModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">导入账号</h3>
            <button class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <div class="form-group">
            <label class="form-label">账号数据 (支持 JSON 或"复制全部"文本格式)</label>
            <textarea class="form-textarea mono" id="importData" placeholder='支持格式:
1. JSON: [{"email": "xxx", "password": "xxx", ...}]
2. 复制全部格式:
登录入口: https://...
区域: us-east-1
用户名: xxx@xxx.com
密码: xxx
2FA密钥: xxx'></textarea>
        </div>
        <div class="form-actions">
            <button class="btn btn-outline" onclick="closeImportModal()">取消</button>
            <button class="btn btn-primary" onclick="importAccounts()">导入</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">编辑账号</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <input type="hidden" id="editEmail">
        <div class="form-group">
            <label class="form-label">编号 (index)</label>
            <input type="number" class="form-input" id="editIndex">
        </div>
        <div class="form-group">
            <label class="form-label">邮箱</label>
            <input type="text" class="form-input" id="editEmailDisplay" readonly style="opacity:0.6">
        </div>
        <div class="form-group">
            <label class="form-label">密码</label>
            <input type="text" class="form-input mono" id="editPassword">
        </div>
        <div class="form-group">
            <label class="form-label">TOTP 密钥</label>
            <input type="text" class="form-input mono" id="editTotp">
        </div>
        <div class="form-group">
            <label class="form-label">Kiro 订阅</label>
            <select class="form-select" id="editKiroPlan">
                <option value="">无</option>
                <option value="pro">Pro ($20)</option>
                <option value="pro+">Pro+ ($40)</option>
                <option value="power">Power ($200)</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn btn-danger" onclick="deleteAccount()">删除</button>
            <button class="btn btn-outline" onclick="closeEditModal()">取消</button>
            <button class="btn btn-primary" onclick="saveAccount()">保存</button>
        </div>
    </div>
</div>

<script>
    // ========== GitHub API Configuration ==========
    const ACCESS_PASSWORD = 'AWS@2026';
    
    // GitHub 配置 - 从 localStorage 或 URL 参数读取
    let GITHUB_CONFIG = {
        token: '',
        repo: '',  // owner/repo
        branch: 'main'
    };

    // 数据文件路径
    const DATA_FILES = {
        accounts: 'accounts.json',
        sales: 'sales.json',
        personal: 'personal.json'
    };

    let accounts = [];
    let salesData = {};
    let personalData = {};
    let currentFilter = 'all';
    let confirmResolve = null;
    let fileShas = {}; // 存储文件 SHA 用于更新

    // ========== GitHub API Helper ==========
    class GitHubAPI {
        constructor(token, repo, branch = 'main') {
            this.token = token;
            this.repo = repo;
            this.branch = branch;
            this.baseUrl = `https://api.github.com/repos/${repo}/contents`;
        }

        async request(path, method = 'GET', body = null) {
            const url = `${this.baseUrl}/${path}?ref=${this.branch}`;
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);
            
            const res = await fetch(url, options);
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.message || `GitHub API error: ${res.status}`);
            }
            return res.json();
        }

        async getFile(path) {
            try {
                const data = await this.request(path);
                fileShas[path] = data.sha;
                const content = atob(data.content);
                return JSON.parse(content);
            } catch (e) {
                if (e.message.includes('404')) {
                    return null;
                }
                throw e;
            }
        }

        async putFile(path, content, message = 'Update data') {
            const base64Content = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));
            const body = {
                message,
                content: base64Content,
                branch: this.branch
            };
            
            if (fileShas[path]) {
                body.sha = fileShas[path];
            }
            
            const res = await this.request(path, 'PUT', body);
            fileShas[path] = res.content.sha;
            return res;
        }
    }

    let github = null;

    // ========== Password Authentication ==========
    function showPasswordModal() {
        document.getElementById('passwordModal').classList.add('active');
        document.getElementById('accessPassword').focus();
    }

    function verifyPassword() {
        const input = document.getElementById('accessPassword').value;
        if (input === ACCESS_PASSWORD) {
            localStorage.setItem('kiro_access', ACCESS_PASSWORD);
            document.getElementById('passwordModal').classList.remove('active');
            init();
        } else {
            document.getElementById('accessPassword').value = '';
            document.getElementById('accessPassword').placeholder = '密码错误，请重试';
        }
    }

    // ========== GitHub Config Modal ==========
    window.showConfigModal = function() {
        document.getElementById('githubToken').value = GITHUB_CONFIG.token || '';
        document.getElementById('githubRepo').value = GITHUB_CONFIG.repo || '';
        document.getElementById('githubBranch').value = GITHUB_CONFIG.branch || 'main';
        document.getElementById('configModal').classList.add('active');
    };

    window.closeConfigModal = function() {
        document.getElementById('configModal').classList.remove('active');
    };

    window.saveGitHubConfig = async function() {
        const token = document.getElementById('githubToken').value.trim();
        const repo = document.getElementById('githubRepo').value.trim();
        const branch = document.getElementById('githubBranch').value.trim() || 'main';

        if (!token || !repo) {
            alert('请填写 Token 和仓库名称');
            return;
        }

        GITHUB_CONFIG = { token, repo, branch };
        localStorage.setItem('github_config', JSON.stringify(GITHUB_CONFIG));
        
        github = new GitHubAPI(token, repo, branch);
        closeConfigModal();
        showToast('配置已保存，正在加载数据...');
        
        try {
            await fetchAccounts();
            showToast('数据加载成功！');
        } catch (e) {
            showToast('加载失败: ' + e.message);
        }
    };

    // ========== Confirm Modal ==========
    function showConfirm(message, title = '确认操作', dangerBtn = false) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        const btn = document.getElementById('confirmBtn');
        btn.className = dangerBtn ? 'btn btn-danger' : 'btn btn-primary';
        document.getElementById('confirmModal').classList.add('active');
        return new Promise(resolve => { confirmResolve = resolve; });
    }

    function closeConfirmModal(result) {
        document.getElementById('confirmModal').classList.remove('active');
        if (confirmResolve) { confirmResolve(result); confirmResolve = null; }
    }

    // ========== Theme ==========
    const themeToggleEl = document.getElementById('themeToggle');
    const themeIconEl = document.getElementById('themeIcon');

    function initTheme() {
        const savedTheme = localStorage.getItem('aws_manager_theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            updateThemeIcon('dark');
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('aws_manager_theme', 'light');
            updateThemeIcon('light');
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('aws_manager_theme', 'dark');
            updateThemeIcon('dark');
        }
    }

    function updateThemeIcon(theme) {
        if (theme === 'dark') {
            themeIconEl.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
        } else {
            themeIconEl.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        }
    }

    themeToggleEl.addEventListener('click', toggleTheme);

    // ========== Init ==========
    function loadGitHubConfig() {
        // 1. 从 URL 参数读取
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        const urlRepo = urlParams.get('repo');
        const urlBranch = urlParams.get('branch');

        if (urlToken && urlRepo) {
            GITHUB_CONFIG = {
                token: urlToken,
                repo: urlRepo,
                branch: urlBranch || 'main'
            };
            // 移除 URL 中的 token 参数（安全）
            window.history.replaceState({}, document.title, window.location.pathname);
            localStorage.setItem('github_config', JSON.stringify(GITHUB_CONFIG));
            return true;
        }

        // 2. 从 localStorage 读取
        const stored = localStorage.getItem('github_config');
        if (stored) {
            try {
                GITHUB_CONFIG = JSON.parse(stored);
                return true;
            } catch (e) {
                console.error('Failed to parse github config', e);
            }
        }

        return false;
    }

    async function init() {
        initTheme();
        setupFilters();

        const hasConfig = loadGitHubConfig();
        
        if (hasConfig && GITHUB_CONFIG.token && GITHUB_CONFIG.repo) {
            github = new GitHubAPI(GITHUB_CONFIG.token, GITHUB_CONFIG.repo, GITHUB_CONFIG.branch);
            await fetchAccounts();
        } else {
            showConfigModal();
        }
    }

    // ========== Data Fetch ==========
    async function fetchAccounts() {
        const gridEl = document.getElementById('account-grid');
        
        if (!github) {
            gridEl.innerHTML = `
                <div class="message-container">
                    <h3 class="error-text">未配置 GitHub</h3>
                    <p>请先配置 GitHub Token 和仓库信息</p>
                    <button class="btn btn-primary" style="margin-top:1rem" onclick="showConfigModal()">配置 GitHub</button>
                </div>
            `;
            return;
        }

        gridEl.innerHTML = `
            <div class="message-container">
                <div class="loading-spinner"></div>
                <p style="margin-top:1rem">正在从 GitHub 加载数据...</p>
            </div>
        `;

        try {
            // 并行加载所有数据文件
            const [accountsData, salesDataRes, personalDataRes] = await Promise.all([
                github.getFile(DATA_FILES.accounts),
                github.getFile(DATA_FILES.sales),
                github.getFile(DATA_FILES.personal)
            ]);

            accounts = accountsData || [];
            salesData = salesDataRes || {};
            personalData = personalDataRes || {};

            render();
            updateStats();
        } catch (err) {
            console.error(err);
            gridEl.innerHTML = `
                <div class="message-container">
                    <h3 class="error-text">加载数据失败</h3>
                    <p>${err.message}</p>
                    <button class="btn btn-outline" style="margin-top:1rem" onclick="showConfigModal()">检查配置</button>
                </div>
            `;
        }
    }

    // ========== Save Data ==========
    async function saveAccounts() {
        if (!github) return;
        try {
            await github.putFile(DATA_FILES.accounts, accounts, 'Update accounts');
        } catch (e) {
            console.error('Save accounts failed:', e);
            showToast('保存账号失败: ' + e.message);
        }
    }

    async function saveSalesData() {
        if (!github) return;
        try {
            await github.putFile(DATA_FILES.sales, salesData, 'Update sales data');
        } catch (e) {
            console.error('Save sales failed:', e);
            showToast('保存销售数据失败: ' + e.message);
        }
        updateStats();
    }

    async function savePersonalData() {
        if (!github) return;
        try {
            await github.putFile(DATA_FILES.personal, personalData, 'Update personal data');
        } catch (e) {
            console.error('Save personal failed:', e);
            showToast('保存自用数据失败: ' + e.message);
        }
        updateStats();
    }

    // ========== Render ==========
    function render() {
        const gridEl = document.getElementById('account-grid');
        gridEl.innerHTML = '';
        
        let filteredAccounts = accounts.filter(acc => {
            const isSold = salesData[acc.email]?.sold || false;
            const isPersonal = personalData[acc.email]?.personal || false;
            if (currentFilter === 'available') return !isSold && !isPersonal;
            if (currentFilter === 'sold') return isSold;
            if (currentFilter === 'personal') return isPersonal && !isSold;
            return true;
        });

        if (currentFilter === 'sold') {
            filteredAccounts.sort((a, b) => {
                const dateA = salesData[a.email]?.date ? new Date(salesData[a.email].date) : new Date(0);
                const dateB = salesData[b.email]?.date ? new Date(salesData[b.email].date) : new Date(0);
                return dateB - dateA;
            });
        } else {
            filteredAccounts.sort((a, b) => {
                const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                return dateB - dateA;
            });
        }

        if (filteredAccounts.length === 0) {
            gridEl.innerHTML = `<div class="message-container">当前筛选条件下没有账号</div>`;
            return;
        }

        filteredAccounts.forEach(acc => {
            const isSold = salesData[acc.email]?.sold || false;
            const saleDate = salesData[acc.email]?.date;
            const isPersonal = personalData[acc.email]?.personal || false;
            
            const card = document.createElement('div');
            card.className = `card ${isSold ? 'sold' : ''}`;
            
            const dateStr = saleDate ? new Date(saleDate).toLocaleDateString() + ' ' + new Date(saleDate).toLocaleTimeString() : '';
            const accountIndex = acc.index || '?';

            const kiroClass = acc.kiro_plan === 'pro+' ? 'pro-plus' : 
                             acc.kiro_plan === 'pro' ? 'pro' : 
                             acc.kiro_plan === 'power' ? 'power' : 'disabled';
            const kiroText = acc.kiro_plan === 'pro+' ? 'Pro+' : 
                            acc.kiro_plan === 'pro' ? 'Pro' : 
                            acc.kiro_plan === 'power' ? 'Power' : '-';
            
            const createdDate = acc.created_at ? new Date(acc.created_at).toLocaleDateString() : '';

            card.innerHTML = `
                <div class="card-header">
                    <div class="account-info">
                        <span class="account-index">a${accountIndex}</span>
                        <div class="account-email" title="${acc.email}">${acc.email}</div>
                        <span class="kiro-badge ${kiroClass}">${kiroText}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <button class="copy-btn-icon" onclick="showEditModal('${acc.email}')" title="编辑">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <div class="status-badge ${isSold ? 'status-sold' : isPersonal ? 'status-personal' : 'status-available'}">
                            ${isSold ? '已售' : isPersonal ? '自用' : '可用'}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="field-group">
                        <span class="field-label">密码</span>
                        <div class="field-value mono" title="点击复制" onclick="copyText('${acc.password}')">••••••••••••</div>
                        <button class="copy-btn-icon" onclick="copyText('${acc.password}')">
                            <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <div class="field-group">
                        <span class="field-label">2FA</span>
                        <div class="field-value mono" title="点击复制" onclick="copyText('${acc.totp_secret}')">••••••••••••••••</div>
                        <button class="copy-btn-icon" onclick="copyText('${acc.totp_secret}')">
                            <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    ${createdDate ? `<div class="created-date">创建于: ${createdDate}</div>` : ''}
                </div>
                <div class="card-footer">
                    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;">
                        <div class="toggle-container">
                            <label class="switch personal">
                                <input type="checkbox" ${isPersonal ? 'checked' : ''} onchange="togglePersonal('${acc.email}', this.checked, this)" ${isSold ? 'disabled' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">${isPersonal ? '自用中' : '标记自用'}</span>
                        </div>
                        <div class="toggle-container">
                            <label class="switch">
                                <input type="checkbox" ${isSold ? 'checked' : ''} onchange="toggleSold('${acc.email}', this.checked, this)">
                                <span class="slider"></span>
                            </label>
                            <div>
                                <span class="toggle-label">${isSold ? '已售出' : '标记已售'}</span>
                                ${isSold && dateStr ? `<span class="sold-date">售出时间: ${dateStr}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    ${!isSold ? `<button class="btn btn-primary btn-sm" onclick="copyFullDetails('${acc.email}')">
                        <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        复制全部
                    </button>` : ''}
                </div>
            `;
            gridEl.appendChild(card);
        });
    }

    // ========== Stats & Filters ==========
    function updateStats() {
        const total = accounts.length;
        const sold = accounts.filter(acc => salesData[acc.email]?.sold).length;
        const personal = accounts.filter(acc => personalData[acc.email]?.personal && !salesData[acc.email]?.sold).length;
        const available = total - sold - personal;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-sold').textContent = sold;
        document.getElementById('stat-personal').textContent = personal;
        document.getElementById('stat-available').textContent = available;
    }

    function setupFilters() {
        const statsBarEl = document.querySelector('.stats-bar');
        const cards = statsBarEl.querySelectorAll('.stat-card.clickable');
        cards.forEach(card => {
            card.addEventListener('click', () => {
                cards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                currentFilter = card.dataset.filter;
                render();
            });
        });
    }

    // ========== Actions ==========
    window.toggleSold = async function(email, isChecked, checkbox) {
        if (isChecked) {
            const ok = await showConfirm('确定要将此账号标记为已售吗？', '标记已售', true);
            if (!ok) { checkbox.checked = false; return; }
            salesData[email] = { sold: true, date: new Date().toISOString() };
        } else {
            const ok = await showConfirm('确定要将此账号恢复为可用状态吗？', '恢复可用');
            if (!ok) { checkbox.checked = true; return; }
            if (salesData[email]) { salesData[email].sold = false; delete salesData[email].date; }
        }
        await saveSalesData();
        render();
    };

    window.togglePersonal = async function(email, isChecked, checkbox) {
        if (isChecked) {
            const ok = await showConfirm('确定要将此账号标记为自用吗？', '标记自用');
            if (!ok) { checkbox.checked = false; return; }
            personalData[email] = { personal: true, date: new Date().toISOString() };
        } else {
            const ok = await showConfirm('确定要取消自用标记吗？', '取消自用');
            if (!ok) { checkbox.checked = true; return; }
            if (personalData[email]) { delete personalData[email]; }
        }
        await savePersonalData();
        render();
    };

    window.copyText = function(text) {
        navigator.clipboard.writeText(text).then(() => showToast('已复制到剪贴板!'));
    };

    window.copyFullDetails = function(email) {
        const acc = accounts.find(a => a.email === email);
        if (!acc) return;
        
        const region = acc.region || 'us-east-1';
        const text = `登录入口: ${acc.portal_url}
区域: ${region}
用户名: ${acc.email}
密码: ${acc.password}
2FA密钥: ${acc.totp_secret}
2FA验证码获取: https://2fa.vip/`;

        navigator.clipboard.writeText(text).then(() => showToast('已复制到剪贴板!'));
    };

    function showToast(msg) {
        const toastEl = document.getElementById('toast');
        toastEl.textContent = msg || '已复制到剪贴板!';
        toastEl.className = 'show';
        setTimeout(() => { toastEl.className = toastEl.className.replace('show', ''); }, 3000);
    }

    // ========== Import ==========
    window.showImportModal = function() {
        document.getElementById('importModal').classList.add('active');
        document.getElementById('importData').value = '';
    };

    window.closeImportModal = function() {
        document.getElementById('importModal').classList.remove('active');
    };

    function parseTextFormat(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const acc = {};
        for (const line of lines) {
            if (line.startsWith('登录入口:')) acc.portal_url = line.replace('登录入口:', '').trim();
            else if (line.startsWith('区域:')) acc.region = line.replace('区域:', '').trim();
            else if (line.startsWith('用户名:')) acc.email = line.replace('用户名:', '').trim();
            else if (line.startsWith('密码:')) acc.password = line.replace('密码:', '').trim();
            else if (line.startsWith('2FA密钥:')) acc.totp_secret = line.replace('2FA密钥:', '').trim();
        }
        return acc;
    }

    window.importAccounts = async function() {
        const data = document.getElementById('importData').value.trim();
        try {
            let newAccounts = [];
            
            if (data.startsWith('[')) {
                newAccounts = JSON.parse(data);
            } else if (data.startsWith('{')) {
                newAccounts = data.split('\n').map(line => line.trim()).filter(line => line.length > 0).map(line => JSON.parse(line));
            } else if (data.includes('登录入口:') || data.includes('用户名:')) {
                const blocks = data.split(/\n\s*\n/).filter(b => b.trim());
                for (const block of blocks) {
                    const acc = parseTextFormat(block);
                    if (acc && acc.email) newAccounts.push(acc);
                }
                if (newAccounts.length === 0) {
                    const acc = parseTextFormat(data);
                    if (acc && acc.email) newAccounts.push(acc);
                }
            } else {
                throw new Error('无法识别的格式');
            }
            
            if (!Array.isArray(newAccounts) || newAccounts.length === 0) {
                throw new Error('未找到有效的账号数据');
            }
            
            let imported = 0;
            for (const acc of newAccounts) {
                if (!acc.email) continue;
                const exists = accounts.find(a => a.email === acc.email);
                if (!exists) {
                    const newAcc = {
                        email: acc.email,
                        password: acc.password || '',
                        totp_secret: acc.totp_secret || '',
                        portal_url: acc.portal_url || 'https://d-90661c1f83.awsapps.com/start/',
                        region: acc.region || 'us-east-1',
                        created_at: acc.created_at || new Date().toISOString(),
                        status: acc.status || 'active',
                        index: acc.index,
                        kiro_plan: acc.kiro_plan
                    };
                    accounts.push(newAcc);
                    imported++;
                }
            }
            
            if (imported > 0) {
                await saveAccounts();
            }
            
            closeImportModal();
            render();
            updateStats();
            showToast(`成功导入 ${imported} 个账号`);
        } catch (e) {
            alert('导入失败: ' + e.message);
        }
    };

    // ========== Edit ==========
    window.showEditModal = function(email) {
        const acc = accounts.find(a => a.email === email);
        if (!acc) return;
        
        document.getElementById('editEmail').value = email;
        document.getElementById('editEmailDisplay').value = email;
        document.getElementById('editIndex').value = acc.index || '';
        document.getElementById('editPassword').value = acc.password || '';
        document.getElementById('editTotp').value = acc.totp_secret || '';
        document.getElementById('editKiroPlan').value = acc.kiro_plan || '';
        document.getElementById('editModal').classList.add('active');
    };

    window.closeEditModal = function() {
        document.getElementById('editModal').classList.remove('active');
    };

    window.saveAccount = async function() {
        const email = document.getElementById('editEmail').value;
        const acc = accounts.find(a => a.email === email);
        if (!acc) return;
        
        const newIndex = document.getElementById('editIndex').value;
        acc.index = newIndex ? parseInt(newIndex) : undefined;
        acc.password = document.getElementById('editPassword').value;
        acc.totp_secret = document.getElementById('editTotp').value;
        acc.kiro_plan = document.getElementById('editKiroPlan').value || undefined;
        
        await saveAccounts();
        closeEditModal();
        render();
        showToast('账号信息已更新');
    };

    window.deleteAccount = async function() {
        const email = document.getElementById('editEmail').value;
        const ok = await showConfirm(`确定要删除账号 ${email} 吗？此操作不可撤销！`, '删除账号', true);
        if (!ok) return;
        
        accounts = accounts.filter(a => a.email !== email);
        await saveAccounts();
        closeEditModal();
        render();
        updateStats();
        showToast('账号已删除');
    };

    // ========== Backup ==========
    window.manualBackup = function() {
        const backupData = {
            timestamp: new Date().toISOString(),
            accounts: accounts,
            salesData: salesData,
            personalData: personalData
        };
        
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        a.download = `aws-iam-backup-${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('数据已备份到本地');
    };

    // ========== Start ==========
    if (localStorage.getItem('kiro_access') !== ACCESS_PASSWORD) {
        document.addEventListener('DOMContentLoaded', showPasswordModal);
    } else {
        document.addEventListener('DOMContentLoaded', init);
    }
</script>

</body>
</html>
